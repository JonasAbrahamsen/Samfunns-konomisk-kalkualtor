<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Samfunnsøkonomisk Kalkulator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
            background-color: #F9FCF3;
            color: #1a1a1a;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        header {
            margin-bottom: 40px;
            text-align: center;
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1a1a1a;
        }

        .subtitle {
            font-size: 16px;
            color: #666;
            font-weight: 400;
        }

        .input-section {
            background: white;
            padding: 32px;
            border-radius: 16px;
            margin-bottom: 40px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .input-row.full {
            grid-template-columns: 1fr;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1a1a1a;
            text-transform: none;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        input[type="text"],
        input[type="number"],
        select {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #4a7c59;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 12px;
        }

        .lifespan-toggle {
            background: white;
            border: 2px solid #e0e0e0;
            color: #1a1a1a;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
            margin-bottom: 40px;
            border-radius: 8px;
            transition: all 0.2s;
            width: 100%;
            box-sizing: border-box;
        }

        .lifespan-toggle:hover {
            border-color: #4a7c59;
            background-color: #f5f9f0;
        }

        .lifespan-content {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f5f9f0;
            border-radius: 8px;
        }

        .lifespan-content.active {
            display: block;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .radio-option:hover {
            border-color: #4a7c59;
            background-color: #f5f9f0;
        }

        .radio-option input[type="radio"] {
            margin-right: 12px;
            cursor: pointer;
            accent-color: #4a7c59;
            flex-shrink: 0;
        }

        .radio-option label {
            margin: 0;
            font-size: 14px;
            cursor: pointer;
            text-transform: none;
            letter-spacing: normal;
            width: 100%;
            display: flex;
            align-items: center;
        }

        .percentage-btn {
            flex: 1;
            min-width: 70px;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            background-color: white;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
            cursor: pointer;
            transition: all 0.2s;
        }

        .percentage-btn:hover {
            border-color: #4a7c59;
            background-color: #f5f9f0;
        }

        .percentage-btn.active {
            border-color: #4a7c59;
            background-color: #4a7c59;
            color: white;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 32px;
        }

        button {
            flex: 1;
            padding: 14px 24px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-calculate {
            background-color: #4a7c59;
            color: white;
        }

        .btn-calculate:hover {
            background-color: #3a6449;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 124, 89, 0.2);
        }

        .btn-reset {
            background-color: #f0f0f0;
            color: #1a1a1a;
        }

        .btn-reset:hover {
            background-color: #e0e0e0;
        }

        .results-section {
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .results-section.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .results-container {
            background: white;
            padding: 32px;
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .results-container h2 {
            font-size: 16px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 20px;
            color: #1a1a1a;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            font-size: 14px;
            color: #666;
        }

        .result-value {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .total-savings {
            background: white;
            border: 3px solid #4a7c59;
            padding: 32px;
            border-radius: 16px;
            text-align: center;
        }

        .total-savings h3 {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            color: #1a1a1a;
        }

        .total-amount {
            font-size: 48px;
            font-weight: 700;
            color: #4a7c59;
            margin-bottom: 8px;
        }

        .total-description {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
        }

        .info-box {
            background: transparent;
            border-left: none;
            padding: 0;
            border-radius: 0;
            margin-bottom: 0;
        }

        .info-box p {
            font-size: 15px;
            color: #1a1a1a;
            line-height: 1.6;
            margin: 0;
        }

        .disclaimer-box {
            background: white;
            border: 2px solid #e0e0e0;
            padding: 24px;
            border-radius: 8px;
            margin-top: 32px;
            font-size: 13px;
            color: #666;
            line-height: 1.7;
        }

        .disclaimer-box a {
            color: #4a7c59;
            text-decoration: none;
            font-weight: 600;
        }

        .disclaimer-box a:hover {
            text-decoration: underline;
        }

        .municipality-note {
            margin-top: 20px;
            padding: 16px;
            background-color: #f5f9f0;
            border-radius: 8px;
            font-size: 13px;
            color: #666;
        }

        .municipality-note strong {
            color: #1a1a1a;
        }

        @media (max-width: 600px) {
            .input-row {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 24px;
            }

            .total-amount {
                font-size: 36px;
            }

            .container {
                padding: 24px 16px;
            }

            .input-section,
            .results-container,
            .total-savings {
                padding: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Samfunnsøkonomiske besparelser av økt fysisk aktivitet</h1>
            <p style="font-size: 16px; color: #666; margin-top: 12px; line-height: 1.6;">
                Kalkulatoren kan brukes av kommuner, regioner, statlige myndigheter og andre aktører som vurderer å iverksette tiltak som kan øke befolkningens aktivitetsnivå.
            </p>
        </header>

        <div class="input-section">
            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #1a1a1a;">Gjør en beregning</h3>
            <h3 style="font-size: 12px; font-weight: 400; color: #666; margin-bottom: 24px;">Velg kommune og aktivitetsnivå i cellene nedfor</h3>

            <div class="input-row">
                <div class="form-group">
                    <label for="municipality">Kommune</label>
                    <input 
                        type="text" 
                        id="municipality" 
                        placeholder="Søk kommune..." 
                        autocomplete="off"
                    >
                    <div id="municipalitySuggestions" style="display: none; position: absolute; background: white; border: 1px solid #e0e0e0; border-radius: 8px; margin-top: 4px; width: calc(50% - 30px); max-height: 200px; overflow-y: auto; z-index: 1000;"></div>
                </div>

                <div class="form-group">
                    <label for="childCount">Antall barnehagebarn (fra år 1)</label>
                    <input 
                        type="number" 
                        id="childCount" 
                        placeholder="0" 
                        min="0"
                    >
                </div>
            </div>

            <div class="input-row full">
                <div class="form-group">
                    <label>Andel barn som forventes å oppnå aktivitetsendring (%)</label>
                    <div style="display: flex; gap: 8px; flex-wrap: nowrap; margin-top: 12px;">
                        <button type="button" class="percentage-btn" data-value="10">10%</button>
                        <button type="button" class="percentage-btn" data-value="20">20%</button>
                        <button type="button" class="percentage-btn active" data-value="30">30%</button>
                        <button type="button" class="percentage-btn" data-value="40">40%</button>
                        <button type="button" class="percentage-btn" data-value="50">50%</button>
                    </div>
                    <input type="hidden" id="percentageValue" value="30">
                </div>
            </div>

            <div class="input-row">
                <div class="form-group">
                    <label>Aktivitetsnivå</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input 
                                type="radio" 
                                id="activity1" 
                                name="activity" 
                                value="delvis-fysisk"
                                checked
                            >
                            <label for="activity1">Delvis aktiv → Fysisk aktiv</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>&nbsp;</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input 
                                type="radio" 
                                id="activity2" 
                                name="activity" 
                                value="fysisk-ekstra"
                            >
                            <label for="activity2">Fysisk aktiv → Ekstra aktiv</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn-calculate" onclick="calculateResults()">Beregn</button>
                <button class="btn-reset" onclick="resetForm()">Nullstill</button>
            </div>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="results-container">
                <h2>Resultat</h2>
                
                <p id="infoText" style="font-size: 15px; color: #1a1a1a; margin-bottom: 20px; line-height: 1.6;"></p>
                
                <div style="margin-bottom: 24px;">

                    <div class="result-item" style="border-bottom: none; padding: 12px 0;">
                        <span class="result-label">Potensiell reduksjon i helsetjenestekostnader per år (2023-kr)</span>
                        <span class="result-value" id="annualReduction">0 kr</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Parkdressen-kostnad per år</span>
                        <span class="result-value" id="parkdressenCost">0 kr</span>
                    </div>
                </div>
            </div>

            <!-- Livsløpsperspektiv sektion -->
            <button class="lifespan-toggle" onclick="toggleLifespan()">
                ▼ Livsløpsperspektiv (potensiell kumulativ gevinst over 70 år)
            </button>

            <div class="lifespan-content" id="lifespanContent">
                <div class="chart-container">
                    <canvas id="lifespanChart"></canvas>
                </div>
                <div style="padding: 16px; background: white; border-radius: 8px; font-size: 13px; color: #666;">
                    <p style="margin-bottom: 12px;">
                        <strong style="color: #1a1a1a;">Potensiell total livsløpsgevinst:</strong> <span id="lifespanTotal">0 kr</span> (for hele kohorten over 70 år)
                    </p>
                    <p style="margin-bottom: 12px;">
                        <strong style="color: #1a1a1a;">Potensiell årlig livsløpsgevinst:</strong> <span id="lifespanAnnual">0 kr</span> (gjennomsnitt per år)
                    </p>
                    <p style="margin-bottom: 12px;">
                        <strong style="color: #1a1a1a;">Årlig parkdressen-kostnad:</strong> <span id="parkdressenLifespanCost">0 kr</span> (for hele kohorten, år 0-5)
                    </p>
                    <p style="margin: 16px 0 12px 0; font-weight: 600; color: #1a1a1a;">Notat:</p>
                    <p style="margin-bottom: 12px;">
                        Grafen viser potensiell kumulativ besparelse fra år 1 til år 70 i barnets liv. Parkdressen-kostnaden vises som en horisontal linje for de første 5 årene (barnehagetiden).
                    </p>
                    <p style="margin: 16px 0 8px 0; font-weight: 600; color: #1a1a1a;">Hva er helsetapsjusterte leveår – DALYs?</p>
                    <p style="margin-bottom: 8px; color: #666;">
                        DALY (Disability-Adjusted Life Year) er et mål på sykdomsbyrden og kan beskrives som gode, eller mer presist som helsetapsjusterte leveår.
                    </p>
                    <p style="color: #666;">
                        Ett godt leveår (1 DALY) har en samfunnsverdi på 1,68 millioner 2023-kroner (Helsedirektoratet 2024b).
                    </p>
                </div>
            </div>

            <div class="total-savings">
                <h3>Kostnader spart</h3>
                <div class="total-amount" id="totalSavings">0 kr</div>
                <div class="total-description" id="totalDescription">
                    Årlig netto besparelse for barnehagebarna
                </div>
                <div class="municipality-note">
                    <strong id="municipalityName">-</strong> kommune har mulighet til å spare betydelige ressurser ved å øke fysisk aktivitet blant barnehagebarna.
                </div>
                <button class="btn-reset" onclick="exportToPDF()" style="margin-top: 20px; width: 100%;">Last ned som PDF</button>
            </div>

        </div>

        <div style="background: white; padding: 24px; border-radius: 8px; font-size: 13px; color: #666; line-height: 1.8;">
            <h3 style="margin-bottom: 16px; color: #1a1a1a; font-weight: 600; font-size: 18px;">Kilder</h3>
            <p style="margin-bottom: 20px;">
                Merk at kalkulatoren ikke sier noe om effekten av tiltak, men kun omtaler potensielle gevinster gitt at det kan iverksettes effektive tiltak. Effekt av tiltak og tiltakskostnader må dokumenteres i spesifikke tiltaksanalyser, for eksempel av abonnement på parkdress.
            </p>
            <p style="margin-bottom: 20px;">
                Denne kalkulatoren er utviklet i utgangspunkt i metodologien og estimatene som brukes i Helsedirektoratets "Kalkulator for helseeffekter av fysisk inaktivitet". Tallgrunnlaget og beregningslogikken er basert på Helsedirektoratets modell for beregning av helsegevinster ved endret fysisk aktivitetsnivå.
            </p>
            <div style="margin-bottom: 20px;">
                <p style="margin-bottom: 12px;">
                    <strong>Helsedirektoratet (2022a)</strong> Voksne og eldre generelle råd fysisk aktivitet. <a href="https://www.helsedirektoratet.no/faglige-rad/fysisk-aktivitet-i-forebygging-og-behandling/voksne-og-eldre" target="_blank" style="color: #4a7c59; text-decoration: none;">https://www.helsedirektoratet.no/faglige-rad/fysisk-aktivitet-i-forebygging-og-behandling/voksne-og-eldre</a>, lastet 08.08.2025.
                </p>
                <p style="margin-bottom: 12px;">
                    <strong>Helsedirektoratet (2022b)</strong> Barn og unge generelle råd fysisk aktivitet. <a href="https://www.helsedirektoratet.no/faglige-rad/fysisk-aktivitet-i-forebygging-og-behandling/barn-og-unge#barn-unge-6-17-ar-rad-anbefaling-fysisk-aktivitet" target="_blank" style="color: #4a7c59; text-decoration: none;">https://www.helsedirektoratet.no/faglige-rad/fysisk-aktivitet-i-forebygging-og-behandling/barn-og-unge#barn-unge-6-17-ar-rad-anbefaling-fysisk-aktivitet</a>, lastet 08.08.2025.
                </p>
                <p style="margin-bottom: 12px;">
                    <strong>Helsedirektoratet (2024a)</strong> Vunne leveår og helsetapsjusterte leveår (DALYs) ved fysisk aktivitet. Økt fysisk aktivitet kan gi redusert sykdomsbyrde. <a href="https://www.helsedirektoratet.no/rapporter/vunne-levear-og-helsetapsjusterte-levear-dalys-ved-fysisk-aktivitet" target="_blank" style="color: #4a7c59; text-decoration: none;">https://www.helsedirektoratet.no/rapporter/vunne-levear-og-helsetapsjusterte-levear-dalys-ved-fysisk-aktivitet</a>, lastet 08.08.2025.
                </p>
                <p style="margin-bottom: 12px;">
                    <strong>Helsedirektoratet (2024b)</strong> Virkninger på helse og livskvalitet i utredninger og samfunnsøkonomiske analyser – temaveileder til utredningsinstruksen. <a href="https://www.helsedirektoratet.no/veiledere/virkninger-pa-helse-og-livskvalitet-i-utredninger-og-samfunnsokonomiske-analyser" target="_blank" style="color: #4a7c59; text-decoration: none;">https://www.helsedirektoratet.no/veiledere/virkninger-pa-helse-og-livskvalitet-i-utredninger-og-samfunnsokonomiske-analyser</a>, lastet 08.08.2025.
                </p>
                <p style="margin-bottom: 12px;">
                    <strong>Helsedirektoratet (2024c)</strong> Samfunnskostnader ved sykdom og ulykker 2019–2021. <a href="https://www.helsedirektoratet.no/rapporter/samfunnskostnader-ved-sykdom-og-ulykker-2019-2021" target="_blank" style="color: #4a7c59; text-decoration: none;">https://www.helsedirektoratet.no/rapporter/samfunnskostnader-ved-sykdom-og-ulykker-2019-2021</a>, lastet 08.08.2025.
                </p>
                <p style="margin-bottom: 12px;">
                    <strong>Helsedirektoratet (2025a)</strong> Dokumentasjonsrapport: Helseeffekter av fysisk aktivitet per km gange og sykling. <a href="https://www.helsedirektoratet.no/rapporter/dokumentasjonsrapport-helseeffekter-av-fysisk-aktivitet-per-km-gange-og-sykling" target="_blank" style="color: #4a7c59; text-decoration: none;">https://www.helsedirektoratet.no/rapporter/dokumentasjonsrapport-helseeffekter-av-fysisk-aktivitet-per-km-gange-og-sykling</a>, lastet 08.08.2025.
                </p>
                <p style="margin-bottom: 12px;">
                    <strong>Helsedirektoratet (2025b)</strong> Helsetjenestekostnader – Estimering av finansieringsansvar for ulike sykdomsgrupper. Suppleringsrapport til Helsedirektoratets rapport om samfunnskostnader ved sykdom og ulykker 2019–2021. <a href="https://www.helsedirektoratet.no/rapporter/helsetjenestekostnader-estimering-av-finansieringsansvar-for-ulike-sykdomsgrupper.suppleringsrapport-til-helsedirektoratets-rapport-om-samfunnskostnader-ved-sykdom-og-ulykker-2019-2021" target="_blank" style="color: #4a7c59; text-decoration: none;">https://www.helsedirektoratet.no/rapporter/helsetjenestekostnader-estimering-av-finansieringsansvar-for-ulike-sykdomsgrupper.suppleringsrapport-til-helsedirektoratets-rapport-om-samfunnskostnader-ved-sykdom-og-ulykker-2019-2021</a>, lastet 08.08.2025.
                </p>
                <p style="margin-bottom: 12px;">
                    <strong>NOU 2025: 8</strong> Folkehelse – verdier, kunnskap og prioritering. <a href="https://www.regjeringen.no/no/dokumenter/nou-2025-8/id3118916/" target="_blank" style="color: #4a7c59; text-decoration: none;">https://www.regjeringen.no/no/dokumenter/nou-2025-8/id3118916/</a>, lastet 14.10.2025.
                </p>
            </div>
        </div>
    </div>

    <script>
        // CSV data source
        const CSV_FILE = 'barnehage_data.csv'; // CSV-filen som ligger i samme mappe
        
        let municipalities = {}; // Will be populated from CSV

        const PARKDRESSEN_COST_PER_CHILD = 1030;
        const HEALTH_SAVINGS_PER_CHILD = {
            'delvis-fysisk': 6776,
            'fysisk-ekstra': 4645
        };

        // Hent data fra CSV-fil ved siden last
        document.addEventListener('DOMContentLoaded', function() {
            fetchMunicipalitiesFromCSV();
        });

        function fetchMunicipalitiesFromCSV() {
            fetch(CSV_FILE)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Kunne ikke laste CSV-fil');
                    }
                    return response.text();
                })
                .then(csvText => {
                    // Parse CSV
                    const lines = csvText.trim().split('\n');
                    
                    if (lines.length > 1) {
                        // Skip header row (row 0)
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (line) {
                                // Split by comma, handling quoted fields
                                const parts = line.split(',');
                                if (parts.length >= 3) {
                                    const kommune = parts[1].trim().replace(/"/g, '');
                                    const antallBarn = parseInt(parts[2]) || 0;
                                    
                                    if (kommune && antallBarn > 0) {
                                        municipalities[kommune] = antallBarn;
                                    }
                                }
                            }
                        }
                    }
                    console.log('Kommune-data lastet fra CSV:', Object.keys(municipalities).length, 'kommuner');
                })
                .catch(error => {
                    console.error('Feil ved henting av kommune-data:', error);
                });
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('no-NO', {
                style: 'currency',
                currency: 'NOK',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        function formatNumberWithSpace(value) {
            const num = Math.round(value);
            if (num >= 10000) {
                return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            }
            return num.toString();
        }

        function formatMillionKr(millionValue) {
            // Konverter fra millioner til hele kroner
            const krValue = Math.round(millionValue * 1000000);
            return new Intl.NumberFormat('no-NO', {
                style: 'currency',
                currency: 'NOK',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(krValue);
        }

        function getMunicipalitySuggestions(input) {
            if (input.length === 0) return [];
            const lowerInput = input.toLowerCase();
            // Hent forslag fra dynamisk lastet kommune-data
            return Object.keys(municipalities)
                .filter(m => m.toLowerCase().includes(lowerInput))
                .slice(0, 10);
        }

        document.getElementById('municipality').addEventListener('input', function(e) {
            const suggestions = getMunicipalitySuggestions(e.target.value);
            const suggestionsDiv = document.getElementById('municipalitySuggestions');
            
            if (suggestions.length > 0) {
                suggestionsDiv.innerHTML = suggestions.map(m => 
                    `<div style="padding: 10px 16px; border-bottom: 1px solid #f0f0f0; cursor: pointer;" onclick="selectMunicipality('${m}')">${m}</div>`
                ).join('');
                suggestionsDiv.style.display = 'block';
            } else {
                suggestionsDiv.style.display = 'none';
            }
        });

        // Event listeners for percentage buttons
        document.querySelectorAll('.percentage-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                // Remove active class from all buttons
                document.querySelectorAll('.percentage-btn').forEach(b => b.classList.remove('active'));
                // Add active class to clicked button
                this.classList.add('active');
                // Store value in hidden input
                document.getElementById('percentageValue').value = this.getAttribute('data-value');
            });
        });

        function selectMunicipality(name) {
            document.getElementById('municipality').value = name;
            document.getElementById('childCount').value = municipalities[name];
            document.getElementById('municipalitySuggestions').style.display = 'none';
        }

        function calculateResults() {
            const municipality = document.getElementById('municipality').value;
            const childCount = parseInt(document.getElementById('childCount').value) || 0;
            const activityType = document.querySelector('input[name="activity"]:checked').value;
            const effectivenessPercentage = parseInt(document.getElementById('percentageValue').value) / 100;

            if (!municipality || childCount === 0) {
                alert('Vennligst fyll inn kommune og antall barn');
                return;
            }

            if (!municipalities[municipality]) {
                alert('Kommune ikke funnet');
                return;
            }

            // Get activity label
            const activityLabels = {
                'delvis-fysisk': 'delvis aktiv til fysisk aktiv',
                'fysisk-ekstra': 'fysisk aktiv til ekstra aktiv'
            };
            const activityLabel = activityLabels[activityType];

            // Calculate values with effectiveness percentage
            const childrenAchievingChange = childCount * effectivenessPercentage;
            const healthSavingsPerChild = HEALTH_SAVINGS_PER_CHILD[activityType];
            const totalHealthSavings = childrenAchievingChange * healthSavingsPerChild;
            const totalParkdressenCost = childCount * PARKDRESSEN_COST_PER_CHILD; // 100% deltar
            const totalSavings = totalHealthSavings - totalParkdressenCost;

            // Format the number with space for info box
            const formattedChildrenCount = formatNumberWithSpace(childrenAchievingChange);

            // Update info box
            const infoText = `Hvis <strong>${formattedChildrenCount}</strong> barnehagebarn <strong>i aldersgruppen fra 1 år</strong>, går fra ${activityLabel} i et livsløpsperspektiv, kan det gi:`;
            document.getElementById('infoText').innerHTML = infoText;

            // Update results - send hele beløp i kr, ikke millioner
            document.getElementById('annualReduction').textContent = formatCurrency(totalHealthSavings);
            document.getElementById('parkdressenCost').textContent = '- ' + formatCurrency(totalParkdressenCost);
            document.getElementById('totalSavings').textContent = formatCurrency(totalSavings);
            document.getElementById('municipalityName').textContent = municipality;
            
            // Update description based on positive or negative savings
            if (totalSavings >= 0) {
                document.getElementById('totalDescription').textContent = 
                    `Årlig netto besparelse når ${formatNumberWithSpace(childrenAchievingChange)} barnehagebarn oppnår aktivitetsendring`;
            } else {
                const healthSavingsText = formatCurrency(totalHealthSavings);
                const parkdressenCostText = formatCurrency(totalParkdressenCost);
                document.getElementById('totalDescription').textContent = 
                    `For å oppnå potensielle helsekostnadsbesparelser på ${healthSavingsText} årlig, må ${municipality} kommune investere ${parkdressenCostText} årlig i Parkdressen.`;
            }

            document.getElementById('resultsSection').classList.add('active');
            
            // Beregn livsløpsperspektiv
            calculateLifespan(childrenAchievingChange, healthSavingsPerChild, totalParkdressenCost);
        }

        function calculateLifespan(childrenAchievingChange, healthSavingsPerChild, totalParkdressenCost) {
            // Constants
            const PARKDRESSEN_YEARS = 5; // Barn er i barnehagen i ca 4-5 år
            const LIFESPAN_YEARS = 70; // Fra 1 år til ~70 år
            const ANNUAL_HEALTH_SAVINGS_PER_CHILD = healthSavingsPerChild;
            const ANNUAL_PARKDRESSEN_COST_PER_CHILD = 1030;
            
            // Beregn årlig helsesparing for barn som oppnår endring
            const totalHealthSavingsPerYear = ANNUAL_HEALTH_SAVINGS_PER_CHILD * childrenAchievingChange;
            
            // Beregn kumulativ gevinst over 70 år (kun helsesparing, ikke Parkdressen)
            let cumulativeSavings = 0;
            const chartData = [];
            
            for (let year = 1; year <= LIFESPAN_YEARS; year++) {
                cumulativeSavings += totalHealthSavingsPerYear;
                chartData.push(Math.max(0, cumulativeSavings / 1000000)); // For grafen i mill. kr
            }
            
            // Total livsløpsgevinst (hele perioden 70 år)
            const totalLifespanSavingsKr = cumulativeSavings;
            const annualLifespanSavingsKr = totalLifespanSavingsKr / LIFESPAN_YEARS;
            
            // Hent årlig Parkdressen-kostnad fra resultat-oversikten
            const parkdressenCostElement = document.getElementById('parkdressenCost').textContent;
            // Fjern "- " og "kr" for å få bare tallet, så parse det
            const parkdressenCostValue = parkdressenCostElement.replace('- ', '').replace(' kr', '').replace(/\s/g, '');
            const annualParkdressenCost = parseInt(parkdressenCostValue) || 0;
            
            // Oppdater HTML
            document.getElementById('lifespanTotal').textContent = formatCurrency(totalLifespanSavingsKr);
            document.getElementById('lifespanAnnual').textContent = formatCurrency(annualLifespanSavingsKr);
            document.getElementById('parkdressenLifespanCost').textContent = formatCurrency(annualParkdressenCost);
            
            // Tegn grafen
            drawLifespanChart(chartData, annualParkdressenCost, childrenAchievingChange, PARKDRESSEN_YEARS);
        }

        function drawLifespanChart(chartData, annualParkdressenCostPerChild, childrenAchievingChange, parkdressenYears) {
            const ctx = document.getElementById('lifespanChart').getContext('2d');
            
            // Fjern eksisterende chart hvis den finnes
            if (window.lifespanChartInstance) {
                window.lifespanChartInstance.destroy();
            }
            
            // Lag nye labels for årene
            const labels = Array.from({length: 71}, (_, i) => i);
            
            // Beregn Parkdressen-kostnad data (kun år 0-5)
            const parkdressenData = [];
            const parkdressenCostPerYear = annualParkdressenCostPerChild * childrenAchievingChange;
            for (let year = 0; year <= 70; year++) {
                if (year <= parkdressenYears) {
                    parkdressenData.push(parkdressenCostPerYear / 1000000); // Konverter til mill. kr
                } else {
                    parkdressenData.push(0);
                }
            }
            
            window.lifespanChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Potensiell kumulativ besparelse',
                            data: chartData,
                            borderColor: '#4a7c59',
                            backgroundColor: 'rgba(74, 124, 89, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            yAxisID: 'y',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {size: 12},
                                color: '#666',
                                usePointStyle: true,
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            titleFont: {size: 14},
                            bodyFont: {size: 13},
                            callbacks: {
                                label: function(context) {
                                    if (context.datasetIndex === 0) {
                                        return 'Besparelse: ' + context.parsed.y.toFixed(1) + ' mill. kr';
                                    } else {
                                        return 'Parkdressen-kostnad: ' + context.parsed.y.toFixed(1) + ' mill. kr/år';
                                    }
                                },
                                title: function(context) {
                                    return 'År ' + context[0].label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Millioner kr'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(0) + ' mill.';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'År i barnets liv'
                            }
                        }
                    }
                }
            });
        }

        function toggleLifespan() {
            const content = document.getElementById('lifespanContent');
            content.classList.toggle('active');
        }

        function resetForm() {
            document.getElementById('municipality').value = '';
            document.getElementById('childCount').value = '';
            document.querySelectorAll('.percentage-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('[data-value="30"]').classList.add('active');
            document.getElementById('percentageValue').value = '30';
            document.getElementById('activity1').checked = true;
            document.getElementById('resultsSection').classList.remove('active');
            document.getElementById('municipalitySuggestions').style.display = 'none';
        }

        // Allow Enter key to calculate
        document.getElementById('childCount').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') calculateResults();
        });

        function exportToPDF() {
            // Hent verdier fra siden
            const municipality = document.getElementById('municipality').value;
            const childCount = parseInt(document.getElementById('childCount').value) || 0;
            const percentageValue = parseInt(document.getElementById('percentageValue').value) || 0;
            const childrenAchievingChange = Math.round(childCount * (percentageValue / 100));
            
            const activityType = document.querySelector('input[name="activity"]:checked').value;
            const activityLabel = activityType === 'delvis-fysisk' ? 
                'Delvis aktiv → Fysisk aktiv' : 
                'Fysisk aktiv → Ekstra aktiv';
            
            const annualReductionText = document.getElementById('annualReduction').textContent;
            const parkdressenCostText = document.getElementById('parkdressenCost').textContent;
            const totalSavingsText = document.getElementById('totalSavings').textContent;
            const lifespanTotalText = document.getElementById('lifespanTotal').textContent;
            const lifespanAnnualText = document.getElementById('lifespanAnnual').textContent;
            const parkdressenLifespanText = document.getElementById('parkdressenLifespanCost').textContent;
            
            const today = new Date();
            const dateStr = today.toLocaleDateString('no-NO', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 15;
            const contentWidth = pageWidth - (margin * 2);
            
            // Farger
            const bgColor = [245, 249, 240]; // #f5f9f0
            const darkText = [26, 26, 26]; // #1a1a1a
            const green = [74, 124, 89]; // #4a7c59
            
            let yPos = margin;
            
            // Bakgrunn
            pdf.setFillColor(...bgColor);
            pdf.rect(0, 0, pageWidth, pageHeight, 'F');
            
            // Tittel
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(18);
            pdf.setTextColor(...green);
            pdf.text('SAMFUNNSØKONOMISK KALKULATOR', margin, yPos);
            pdf.text('RAPPORT', margin, yPos + 8);
            yPos += 18;
            
            // Kommune og dato
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(11);
            pdf.setTextColor(...darkText);
            pdf.text(`KOMMUNE: ${municipality}`, margin, yPos);
            yPos += 6;
            pdf.text(`DATO: ${dateStr}`, margin, yPos);
            yPos += 12;
            
            // Linje
            pdf.setDrawColor(...green);
            pdf.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 8;
            
            // BEREGNINGSGRUNNLAG
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(12);
            pdf.setTextColor(...green);
            pdf.text('BEREGNINGSGRUNNLAG', margin, yPos);
            yPos += 8;
            
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(10);
            pdf.setTextColor(...darkText);
            const beregningsData = [
                [`Antall barnehagebarn (1-5 år):`, `${childCount.toLocaleString('no-NO')}`],
                [`Andel som oppnår aktivitetsendring:`, `${percentageValue}%`],
                [`Barn som oppnår endring:`, `${childrenAchievingChange.toLocaleString('no-NO')}`],
                [`Aktivitetsendring:`, activityLabel]
            ];
            
            beregningsData.forEach(([label, value]) => {
                pdf.text(label, margin, yPos);
                pdf.text(value, pageWidth - margin - 40, yPos, { align: 'right' });
                yPos += 5;
            });
            yPos += 4;
            
            // Linje
            pdf.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 8;
            
            // RESULTAT - ÅRLIG BESPARELSE
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(12);
            pdf.setTextColor(...green);
            pdf.text('RESULTAT - ÅRLIG BESPARELSE', margin, yPos);
            yPos += 8;
            
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(10);
            pdf.setTextColor(...darkText);
            const resultatData = [
                [`Potensiell helsekostnadsbesparelse:`, annualReductionText],
                [`Parkdressen-kostnad:`, parkdressenCostText],
                ['', '']
            ];
            
            resultatData.forEach(([label, value]) => {
                if (label === '') {
                    pdf.line(margin, yPos, pageWidth - margin, yPos);
                } else {
                    pdf.text(label, margin, yPos);
                    pdf.text(value, pageWidth - margin - 40, yPos, { align: 'right' });
                }
                yPos += 5;
            });
            
            pdf.setFont('helvetica', 'bold');
            pdf.text('Årlig netto besparelse:', margin, yPos);
            pdf.text(totalSavingsText, pageWidth - margin - 40, yPos, { align: 'right' });
            yPos += 8;
            
            // Linje
            pdf.setFont('helvetica', 'normal');
            pdf.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 8;
            
            // LIVSLØPSPERSPEKTIV
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(12);
            pdf.setTextColor(...green);
            pdf.text('LIVSLØPSPERSPEKTIV (70 ÅR)', margin, yPos);
            yPos += 8;
            
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(10);
            pdf.setTextColor(...darkText);
            const lifeData = [
                [`Potensiell total livsløpsgevinst:`, lifespanTotalText],
                [`Potensiell årlig gjennomsnitt:`, lifespanAnnualText],
                [`Årlig Parkdressen-kostnad:`, parkdressenLifespanText]
            ];
            
            lifeData.forEach(([label, value]) => {
                pdf.text(label, margin, yPos);
                pdf.text(value, pageWidth - margin - 40, yPos, { align: 'right' });
                yPos += 5;
            });
            yPos += 6;
            
            // Linje
            pdf.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 8;
            
            // KILDER
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(12);
            pdf.setTextColor(...green);
            pdf.text('KILDER', margin, yPos);
            yPos += 8;
            
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(9);
            pdf.setTextColor(...darkText);
            pdf.text('Helsedirektoratet: Samfunnsøkonomiske kostnader av fysisk inaktivitet – kalkulator', margin, yPos);
            yPos += 4;
            pdf.text('NOU 2025: 8', margin, yPos);
            yPos += 8;
            
            // Disclaimer
            pdf.setFontSize(8);
            const disclaimer1 = 'Merk at kalkulatoren ikke sier noe om effekten av tiltak, men kun omtaler potensielle gevinster gitt at det kan iverksettes effektive tiltak. Effekt av tiltak og tiltakskostnader må dokumenteres i spesifikke tiltaksanalyser, for eksempel av abonnement på parkdress.';
            const disclaimer2 = 'Denne kalkulatoren er utviklet i utgangspunkt i metodologien og estimatene som brukes i Helsedirektoratets "Kalkulator for helseeffekter av fysisk inaktivitet". Tallgrunnlaget og beregningslogikken er basert på Helsedirektoratets modell for beregning av helsegevinster ved endret fysisk aktivitetsnivå.';
            
            const splitDisclaimer1 = pdf.splitTextToSize(disclaimer1, contentWidth);
            const splitDisclaimer2 = pdf.splitTextToSize(disclaimer2, contentWidth);
            
            pdf.text(splitDisclaimer1, margin, yPos);
            yPos += (splitDisclaimer1.length * 3.5) + 4;
            pdf.text(splitDisclaimer2, margin, yPos);
            yPos += (splitDisclaimer2.length * 3.5) + 8;
            
            // Linje
            pdf.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 8;
            
            // KONTAKT
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(12);
            pdf.setTextColor(...green);
            pdf.text('KONTAKT', margin, yPos);
            yPos += 8;
            
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(10);
            pdf.setTextColor(...darkText);
            pdf.text('Henrik Hojem', margin, yPos);
            yPos += 5;
            pdf.text('909 82 181', margin, yPos);
            yPos += 5;
            pdf.text('Henrik@liis.com', margin, yPos);
            
            pdf.save('samfunnsokonomisk-rapport.pdf');
        }
    </script>
</body>
</html>